// ===== MOBILE VIDEO FIXES =====
function fixMobileVideo() {
    const video = document.getElementById('background-video');
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (!video) return;
    
    // iOS Safari specific fixes
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    
    // Force inline playback on iOS
    if (isIOS) {
        video.setAttribute('playsinline', '');
        video.setAttribute('webkit-playsinline', '');
        video.setAttribute('x-webkit-airplay', 'deny');
        
        // iOS sometimes ignores muted, so we set volume to 0
        video.volume = 0;
        video.muted = true;
    }
    
    // Ensure video is muted and has no controls
    video.muted = true;
    video.volume = 0;
    video.controls = false;
    
    // Try to play video
    function tryPlayVideo() {
        const playPromise = video.play();
        
        if (playPromise !== undefined) {
            playPromise.then(() => {
                console.log('Video autoplay started successfully');
            }).catch(error => {
                console.log('Video autoplay prevented:', error);
                // Try again on user interaction
                document.addEventListener('click', function playOnClick() {
                    video.play().then(() => {
                        console.log('Video started on user click');
                    }).catch(e => {
                        console.log('Video play on click failed:', e);
                    });
                    document.removeEventListener('click', playOnClick);
                }, { once: true });
            });
        }
    }
    
    // Wait for video to load
    if (video.readyState >= 3) { // HAVE_FUTURE_DATA
        tryPlayVideo();
    } else {
        video.addEventListener('canplay', tryPlayVideo, { once: true });
    }
    
    // Also try on load
    window.addEventListener('load', function() {
        setTimeout(tryPlayVideo, 1000);
    });
    
    // Handle page visibility changes
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            video.pause();
        } else {
            video.play().catch(e => console.log('Resume play failed:', e));
        }
    });
    
    // Handle video errors
    video.addEventListener('error', function(e) {
        console.error('Video error:', video.error);
    });
}

// ===== HEADER SCROLL EFFECT =====
function initHeaderScroll() {
    const header = document.getElementById('main-header');
    
    if (header) {
        window.addEventListener('scroll', function() {
            if (window.scrollY > 100) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
        });
    }
}

// ===== MOBILE MENU TOGGLE =====
function initMobileMenu() {
    const menuToggle = document.getElementById('menu-toggle');
    const mainNav = document.getElementById('main-nav');
    const navLinks = document.querySelectorAll('.nav-link');
    
    if (menuToggle && mainNav) {
        menuToggle.addEventListener('click', function() {
            mainNav.classList.toggle('active');
            // Change icon based on menu state
            const icon = menuToggle.querySelector('i');
            if (mainNav.classList.contains('active')) {
                icon.classList.remove('fa-bars');
                icon.classList.add('fa-times');
            } else {
                icon.classList.remove('fa-times');
                icon.classList.add('fa-bars');
            }
        });
        
        // Close mobile menu when clicking on a link
        navLinks.forEach(link => {
            link.addEventListener('click', function() {
                mainNav.classList.remove('active');
                if (menuToggle.querySelector('i')) {
                    menuToggle.querySelector('i').classList.remove('fa-times');
                    menuToggle.querySelector('i').classList.add('fa-bars');
                }
                
                // Update active link
                navLinks.forEach(item => item.classList.remove('active'));
                this.classList.add('active');
            });
        });
    }
}

// ===== SCROLL TO TOP BUTTON =====
function initScrollToTop() {
    const scrollTopButton = document.getElementById('scroll-top');
    
    if (scrollTopButton) {
        // Show/hide button on scroll
        window.addEventListener('scroll', function() {
            if (window.scrollY > 500) {
                scrollTopButton.classList.add('visible');
            } else {
                scrollTopButton.classList.remove('visible');
            }
        });
        
        // Scroll to top when clicked
        scrollTopButton.addEventListener('click', function() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
    }
}

// ===== SMOOTH SCROLLING =====
function initSmoothScrolling() {
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function(e) {
            const href = this.getAttribute('href');
            
            // Skip if it's just "#"
            if (href === '#') return;
            
            e.preventDefault();
            
            const targetElement = document.querySelector(href);
            if (targetElement) {
                window.scrollTo({
                    top: targetElement.offsetTop - 80,
                    behavior: 'smooth'
                });
            }
        });
    });
}

// ===== CHARACTER FILTERING =====
function initCharacterFilters() {
    const filterButtons = document.querySelectorAll('.filter-btn');
    const characterCards = document.querySelectorAll('.character-card');
    
    if (filterButtons.length === 0 || characterCards.length === 0) return;
    
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            filterButtons.forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');
            
            const filterValue = this.getAttribute('data-filter');
            
            // Filter character cards
            characterCards.forEach(card => {
                const categories = card.getAttribute('data-category').split(' ');
                
                if (filterValue === 'all' || categories.includes(filterValue)) {
                    card.style.display = 'block';
                    // Add animation when showing
                    setTimeout(() => {
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, 100);
                } else {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(20px)';
                    setTimeout(() => {
                        card.style.display = 'none';
                    }, 300);
                }
            });
        });
    });
}

// ===== ENHANCED TIMELINE ANIMATIONS =====
function initTimelineAnimations() {
    const timelineItems = document.querySelectorAll('.timeline-item');
    const timelineProgress = document.querySelector('.timeline-progress');
    
    if (timelineItems.length === 0) return;
    
    function updateTimeline() {
        let totalHeight = 0;
        let animatedHeight = 0;
        
        timelineItems.forEach((item, index) => {
            const rect = item.getBoundingClientRect();
            const windowHeight = window.innerHeight;
            
            // Calculate total timeline height
            if (index === timelineItems.length - 1) {
                totalHeight = rect.bottom;
            }
            
            // Animate item when in view
            if (rect.top < windowHeight * 0.8) {
                if (!item.classList.contains('animated')) {
                    // Stagger animation
                    setTimeout(() => {
                        item.classList.add('animated');
                    }, index * 300);
                }
                
                // Calculate progress for this item
                if (rect.top < windowHeight * 0.5) {
                    animatedHeight = rect.bottom;
                }
            }
        });
        
        // Update progress bar
        if (timelineProgress && totalHeight > 0) {
            const progressPercentage = (animatedHeight / totalHeight) * 100;
            timelineProgress.style.height = `${Math.min(100, progressPercentage)}%`;
        }
    }
    
    // Initial update
    updateTimeline();
    
    // Update on scroll
    window.addEventListener('scroll', updateTimeline);
    
    // Add hover effects to timeline circles
    timelineItems.forEach(item => {
        const circle = item.querySelector('.circle-content');
        
        if (circle) {
            circle.addEventListener('mouseenter', function() {
                this.style.transform = 'scale(1.2)';
                this.style.boxShadow = '0 0 20px rgba(255, 0, 85, 0.5)';
            });
            
            circle.addEventListener('mouseleave', function() {
                this.style.transform = 'scale(1)';
                this.style.boxShadow = 'none';
            });
        }
    });
}

// ===== AUTHOR SECTION ANIMATIONS =====
function initAuthorAnimations() {
    const authorFrame = document.querySelector('.author-frame');
    
    if (authorFrame) {
        authorFrame.addEventListener('mouseenter', function() {
            const energy = this.querySelector('.author-energy');
            if (energy) {
                energy.style.animationDuration = '1s';
            }
        });
        
        authorFrame.addEventListener('mouseleave', function() {
            const energy = this.querySelector('.author-energy');
            if (energy) {
                energy.style.animationDuration = '4s';
            }
        });
    }
}

// ===== SCROLL ANIMATIONS =====
function initScrollAnimations() {
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('animated');
                
                // Add special effect for character cards
                if (entry.target.classList.contains('character-card')) {
                    const image = entry.target.querySelector('.character-image');
                    if (image) {
                        image.style.animation = 'cursed-frame-appear 0.5s ease-out';
                    }
                }
                
                // Fill level bars when character cards are in view
                if (entry.target.classList.contains('character-card')) {
                    const levelFills = entry.target.querySelectorAll('.level-fill');
                    levelFills.forEach(bar => {
                        const level = bar.getAttribute('data-level');
                        setTimeout(() => {
                            bar.style.width = level + '%';
                        }, 500);
                    });
                }
            }
        });
    }, observerOptions);
    
    // Add frame appear animation
    const frameStyle = document.createElement('style');
    frameStyle.textContent = `
        @keyframes cursed-frame-appear {
            0% {
                opacity: 0;
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
    `;
    document.head.appendChild(frameStyle);
    
    // Observe all elements
    document.querySelectorAll('.timeline-item, .character-card, .technique-card, .section-title, .section-subtitle').forEach(item => {
        if (item) observer.observe(item);
    });
}

// ===== CREATE CURSED PARTICLES =====
function createCursedParticles() {
    const particlesContainer = document.querySelector('.cursed-particles');
    if (!particlesContainer) return;
    
    // Check if mobile (don't create particles on mobile for performance)
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    if (isMobile) {
        particlesContainer.style.display = 'none';
        return;
    }
    
    // Clear existing particles
    particlesContainer.innerHTML = '';
    
    // Create particles
    const particleCount = 30;
    
    for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'cursed-particle';
        
        // Random properties
        const size = Math.random() * 4 + 1;
        const posX = Math.random() * 100;
        const posY = Math.random() * 100;
        const delay = Math.random() * 10;
        const duration = Math.random() * 20 + 10;
        const color = Math.random() > 0.7 ? '#ff0055' : 
                     Math.random() > 0.5 ? '#6a0dad' : '#ffffff';
        const animationType = Math.floor(Math.random() * 3) + 1;
        
        // Set styles
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.backgroundColor = color;
        particle.style.boxShadow = `0 0 ${size * 3}px ${color}`;
        particle.style.left = `${posX}%`;
        particle.style.top = `${posY}%`;
        particle.style.opacity = '0';
        particle.style.position = 'absolute';
        particle.style.borderRadius = '50%';
        particle.style.pointerEvents = 'none';
        
        // Set animation
        particle.style.animation = `
            particle-float-${animationType} ${duration}s linear ${delay}s infinite
        `;
        
        particlesContainer.appendChild(particle);
    }
    
    // Add particle animations
    const particleStyle = document.createElement('style');
    particleStyle.textContent = `
        @keyframes particle-float-1 {
            0%, 100% {
                transform: translate(0, 0);
                opacity: 0;
            }
            50% {
                transform: translate(50px, -50px);
                opacity: 0.6;
            }
        }
        
        @keyframes particle-float-2 {
            0%, 100% {
                transform: translate(0, 0);
                opacity: 0;
            }
            50% {
                transform: translate(-50px, -70px);
                opacity: 0.6;
            }
        }
        
        @keyframes particle-float-3 {
            0%, 100% {
                transform: translate(0, 0);
                opacity: 0;
            }
            50% {
                transform: translate(70px, 30px);
                opacity: 0.6;
            }
        }
    `;
    document.head.appendChild(particleStyle);
}

// ===== INITIALIZE HERO ANIMATIONS =====
function initHeroAnimations() {
    // Start title animations
    const titleWords = document.querySelectorAll('.title-word');
    titleWords.forEach((word, index) => {
        setTimeout(() => {
            word.style.animationPlayState = 'running';
        }, index * 300 + 500);
    });
    
    // Start subtitle animation
    const subtitle = document.querySelector('.hero-subtitle');
    if (subtitle) {
        setTimeout(() => {
            subtitle.style.animationPlayState = 'running';
        }, 1200);
    }
    
    // Start description animation
    const description = document.querySelector('.hero-description');
    if (description) {
        setTimeout(() => {
            description.style.animationPlayState = 'running';
        }, 1500);
    }
    
    // Start buttons animation
    const buttons = document.querySelector('.hero-buttons');
    if (buttons) {
        setTimeout(() => {
            buttons.style.animationPlayState = 'running';
        }, 1800);
    }
    
    // Start scroll indicator animation
    const scrollIndicator = document.querySelector('.scroll-indicator');
    if (scrollIndicator) {
        setTimeout(() => {
            scrollIndicator.style.animationPlayState = 'running';
        }, 2100);
    }
}

// ===== MAIN INITIALIZATION =====
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing Jujutsu Kaisen website...');
    
    // Initialize mobile video fixes
    fixMobileVideo();
    
    // Initialize core features
    initHeaderScroll();
    initMobileMenu();
    initSmoothScrolling();
    initScrollToTop();
    
    // Initialize content features
    initCharacterFilters();
    initTimelineAnimations();
    initAuthorAnimations();
    initScrollAnimations();
    
    // Initialize animations
    initHeroAnimations();
    
    // Create particles
    createCursedParticles();
    
    console.log('Website initialization complete!');
});

// ===== WINDOW LOAD HANDLER =====
window.addEventListener('load', function() {
    // Re-check video autoplay on load
    const video = document.getElementById('background-video');
    if (video) {
        setTimeout(() => {
            video.play().catch(e => console.log('Video autoplay on load failed:', e));
        }, 1000);
    }
});

// ===== ERROR HANDLING =====
window.addEventListener('error', function(e) {
    console.error('Global error:', e.error);
});

// ===== RESIZE HANDLER =====
let resizeTimeout;
window.addEventListener('resize', function() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(function() {
        // Re-initialize timeline on resize
        initTimelineAnimations();
    }, 250);
});
